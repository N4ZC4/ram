<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RAM | Final Boss</title>
  <style>
    :root{
      --bg:#070a07; --panel:#0b120b; --text:#cfe8cf; --muted:#86a186;
      --green:#5dff78; --amber:#ffd65d; --red:#ff5d5d; --border:#173017;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    body{margin:0; background:radial-gradient(1100px 600px at 25% 10%, #0b160b 0%, var(--bg) 55%);
      color:var(--text); font-family:var(--mono); letter-spacing:.2px;}
    .wrap{max-width:1100px; margin:0 auto; padding:22px 16px 60px;}
    .top{border:1px solid var(--border); background:linear-gradient(180deg,#0b160b,#070a07);
      border-radius:16px; padding:14px 14px 12px; box-shadow:0 10px 28px rgba(0,0,0,.35);}
    h1{margin:0 0 6px; font-size:16px; color:var(--green);}
    .sub{color:var(--muted); font-size:12px; line-height:1.45;}
    .pill{display:inline-flex; gap:10px; align-items:center; margin-top:10px;
      border:1px solid var(--border); background:#081008; padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted);}
    .pill b{color:var(--text);}
    .grid{display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:12px; margin-top:14px;}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2, minmax(0, 1fr));}}
    @media (max-width:560px){.grid{grid-template-columns:1fr;}}
    .card{border:1px solid var(--border); background:linear-gradient(180deg,#0a130a,#070a07);
      border-radius:16px; padding:12px; box-shadow:0 10px 22px rgba(0,0,0,.25); position:relative;}
    .card.locked::before{content:"LOCKED"; position:absolute; top:10px; right:10px; font-size:11px;
      color:rgba(255,214,93,.95); border:1px solid rgba(255,214,93,.35); background:rgba(255,214,93,.06);
      padding:3px 8px; border-radius:999px;}
    .card.open::before{content:"OPEN"; color:rgba(93,255,120,.95); border:1px solid rgba(93,255,120,.35);
      background:rgba(93,255,120,.06);}
    .head{display:flex; align-items:baseline; justify-content:space-between; gap:10px;}
    .title{margin:0; font-size:13px;}
    .tag{font-size:11px; color:var(--muted); border:1px solid var(--border); background:#081008; padding:3px 8px; border-radius:999px;}
    .chest{
      margin-top:10px; border:1px dashed #234523; background:rgba(93,255,120,.035);
      border-radius:14px; padding:10px; color:var(--muted); font-size:12px; line-height:1.45;
    }
    label{font-size:12px; color:var(--muted);}
    input{
      width:100%; background:#061006; color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:10px; outline:none; font-family:var(--mono);
    }
    input:focus{border-color:#2a6a2a; box-shadow:0 0 0 3px rgba(93,255,120,.08);}
    .row{display:flex; gap:8px; align-items:flex-end; margin-top:10px;}
    button{
      background:linear-gradient(180deg,#0f1c0f,#081108);
      color:var(--text); border:1px solid var(--border);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-family:var(--mono); font-size:12px;
      white-space:nowrap;
    }
    button:hover{border-color:#2a6a2a;}
    .log{margin-top:10px; font-size:12px; background:#060c06; border:1px solid var(--border);
      border-radius:12px; padding:10px; color:var(--muted); white-space:pre-wrap;}
    .ok{color:var(--green);} .warn{color:var(--amber);} .err{color:var(--red);}
    .final{margin-top:14px; border:1px solid rgba(93,255,120,.35); background:rgba(93,255,120,.06);
      border-radius:16px; padding:14px; display:none;}
    .final.show{display:block;}
    .final h2{margin:0 0 8px; font-size:14px; color:var(--green);}
    .final .riddle{color:var(--muted); font-size:12px; line-height:1.5;}
    .final .riddle ul{margin:8px 0 0 18px; padding:0;}
    .final .riddle li{margin:4px 0;}
    .builder{margin-top:14px; border:1px solid rgba(255,214,93,.35); background:rgba(255,214,93,.06);
      border-radius:16px; padding:14px; display:none;}
    .builder.show{display:block;}
    textarea{
      width:100%; min-height:130px; background:#061006; color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:10px; outline:none; font-family:var(--mono);
    }
    a{color:var(--green); text-decoration:none;}
    a:hover{text-decoration:underline;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h1>fsociety // Final Boss</h1>
    <div class="sub">
      9 σεντούκια. 9 κλειδιά. Κάθε ξεκλείδωμα αποκαλύπτει ένα κομμάτι του τελικού γρίφου.
      Μόλις ανοίξουν όλα, θα χρειαστεί να βγάλεις το τελικό <b>flag</b>. Με το σωστό flag θα εμφανιστεί ο σύνδεσμος “δήλωσης”.
    </div>
    <div class="pill"><span class="ok">●</span> Πρόοδος: <b id="prog">0/9</b> · Vault: <b id="vault" class="warn">LOCKED</b></div>
  </div>

  <!-- Instructor builder (use ?build=1) -->
  <div id="builder" class="builder">
    <div class="sub"><b>Instructor Builder</b> — άνοιξε τη σελίδα με <code>?build=1</code>, κάνε paste τα 9 keys (ένα ανά γραμμή) και πάρε έτοιμο JSON για <code>CONFIG.keyHashes</code>.</div>
    <div style="margin-top:10px"><textarea id="keysIn" placeholder="KEY1&#10;KEY2&#10;...&#10;KEY9"></textarea></div>
    <div class="row">
      <button id="btnBuild">Generate keyHashes</button>
    </div>
    <div class="log" id="buildOut">Waiting…</div>
  </div>

  <div class="grid" id="chests"></div>

  <div class="final" id="final">
    <h2>Final Riddle</h2>
    <div class="riddle">
      Έχεις πλέον όλα τα κομμάτια. Το τελικό flag προκύπτει από τα 9 shards που έδωσαν τα rooms.
      <ul>
        <li><b>Splice Order</b>: “EVENS first, ODDS later”.</li>
        <li>Το master string ξεκινά με <code>fsociety|</code> και χρησιμοποιεί <code>|</code> ως separator (χωρίς κενά).</li>
        <li>Στο τέλος προσθέτεις το “salt” που έμαθες από τα σεντούκια.</li>
        <li>Υπολογίζεις <b>SHA-256</b> του master string (UTF-8).</li>
        <li>Παίρνεις τα <b>πρώτα 12</b> hex (UPPERCASE).</li>
        <li>Flag format: <code>RAM{XMAS_&lt;12HEX&gt;}</code></li>
      </ul>
    </div>

    <div class="row">
      <div style="flex:1; min-width:260px;">
        <label for="flagIn">Final Flag</label>
        <input id="flagIn" placeholder="RAM{XMAS_...}" autocomplete="off" />
      </div>
      <button id="btnFlag">Submit</button>
    </div>
    <div class="log" id="flagLog">Status: waiting…</div>

    <div id="reward" style="display:none; margin-top:12px;">
      <div class="log"><span class="ok">Unlocked:</span> Merry Hacking Christmas</div>
      <div class="log">
        Δήλωσε ότι το βρήκες εδώ:
        <div style="margin-top:8px;"><a id="sheetLink" href="#" target="_blank" rel="noreferrer">Open Google Sheet</a></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================
   CONFIG — ΑΛΛΑΖΕΙΣ ΜΟΝΟ ΕΔΩ
   ====================== */
const CONFIG = {
  // Βάλε εδώ 9 SHA-256 hex digests (lowercase) για τα keys/shards S1..S9
  // (Use builder mode ?build=1)
  keyHashes: [
    "PUT_SHA256_OF_S1_HERE",
    "PUT_SHA256_OF_S2_HERE",
    "PUT_SHA256_OF_S3_HERE",
    "PUT_SHA256_OF_S4_HERE",
    "PUT_SHA256_OF_S5_HERE",
    "PUT_SHA256_OF_S6_HERE",
    "PUT_SHA256_OF_S7_HERE",
    "PUT_SHA256_OF_S8_HERE",
    "PUT_SHA256_OF_S9_HERE",
  ],
  // Salt που θα “αποκαλυφθεί” μέσω σεντουκιού (το master string τη χρειάζεται)
  salt: "redwheelbarrow",
  // Base64 του Google Sheet URL (ώστε να μην είναι ωμό στο source)
  // π.χ. btoa("https://docs.google.com/spreadsheets/d/....")
  sheetUrlB64: "PUT_BASE64_SHEET_URL_HERE",
};

/* ======================
   Data model
   ====================== */
const ORDER = ["S2","S4","S6","S8","S1","S3","S5","S7","S9"]; // EVENS then ODDS
const IDS   = ["S1","S2","S3","S4","S5","S6","S7","S8","S9"]; // for chest indexing

const CLUES = {
  S1: "Σημείωση #1: Οι ‘μονές’ έρχονται ΜΕΤΑ. (ODDS later.)",
  S2: "Σημείωση #2: Ξεκίνα με τις ‘ζυγές’. (EVENS first.)",
  S3: "Σημείωση #3: Prefix: fsociety|",
  S4: "Σημείωση #4: Separator: | (pipe). No spaces.",
  S5: "Σημείωση #5: Το lock αγαπάει τη λέξη: redwheelbarrow",
  S6: "Σημείωση #6: Fingerprint: SHA-256 (UTF-8).",
  S7: "Σημείωση #7: Πάρε τα πρώτα 12 hex, UPPERCASE.",
  S8: "Σημείωση #8: Flag format: RAM{XMAS_<12HEX>}",
  S9: "Σημείωση #9: Το splice order είναι 2-4-6-8-1-3-5-7-9.",
};

const state = {
  opened: Object.fromEntries(IDS.map(id => [id, false])),
  keys:   Object.fromEntries(IDS.map(id => [id, ""])),
};

const $ = (id) => document.getElementById(id);

async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

function b64Decode(s){
  try { return atob(s); } catch { return ""; }
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function progress(){
  return Object.values(state.opened).filter(Boolean).length;
}

function updateTop(){
  $("prog").textContent = `${progress()}/9`;
  if(progress() === 9){
    $("vault").textContent = "READY";
    $("vault").classList.remove("warn");
    $("vault").classList.add("ok");
    $("final").classList.add("show");
  }
}

function chestCard(id){
  const n = id.substring(1);
  return `
    <div class="card locked" id="card-${id}">
      <div class="head">
        <div class="title">Chest ${n}</div>
        <div class="tag">${id}</div>
      </div>

      <div class="chest" id="clue-${id}" style="display:none;"></div>

      <div style="margin-top:10px;">
        <label for="key-${id}">Key (${id})</label>
        <input id="key-${id}" placeholder="enter key" autocomplete="off" />
      </div>

      <div class="row">
        <button id="btn-${id}">Unlock</button>
      </div>

      <div class="log" id="log-${id}">Status: locked</div>
    </div>
  `;
}

function mount(){
  $("chests").innerHTML = IDS.map(chestCard).join("");
  IDS.forEach((id, idx) => {
    $(`btn-${id}`).addEventListener("click", () => unlockChest(id, idx));
  });
  $("btnFlag").addEventListener("click", submitFlag);
  updateTop();
}

async function unlockChest(id, idx){
  const input = ($(`key-${id}`).value || "").trim();
  const log = $(`log-${id}`);
  const card = $(`card-${id}`);

  if(!input){
    log.innerHTML = `Status: <span class="err">missing key</span>`;
    return;
  }

  const expectedHash = (CONFIG.keyHashes[idx] || "").toLowerCase().trim();
  if(!expectedHash || expectedHash.includes("PUT_SHA256")){
    log.innerHTML = `Status: <span class="warn">config incomplete</span>\n- Fill CONFIG.keyHashes[${idx}]`;
    return;
  }

  const h = await sha256Hex(input);
  if(h !== expectedHash){
    log.innerHTML = `Status: <span class="err">wrong key</span>\n- try again`;
    return;
  }

  state.opened[id] = true;
  state.keys[id] = input;

  card.classList.remove("locked");
  card.classList.add("open");
  log.innerHTML = `Status: <span class="ok">opened</span>`;

  const clueBox = $(`clue-${id}`);
  clueBox.style.display = "block";
  clueBox.innerHTML = `<b>Clue:</b> ${escapeHtml(CLUES[id])}`;

  updateTop();
}

async function expectedFlagFromKeys(){
  // build master: fsociety|<S2>|<S4>|...|<S9>|<salt>
  const shards = ORDER.map(k => state.keys[k] || "");
  if(shards.some(s => !s)) return "";

  const master = "fsociety|" + shards.join("|") + "|" + CONFIG.salt;
  const digest = await sha256Hex(master);
  const head12 = digest.slice(0, 12).toUpperCase();
  return `RAM{XMAS_${head12}}`;
}

async function submitFlag(){
  const log = $("flagLog");
  if(progress() !== 9){
    log.innerHTML = `Status: <span class="warn">not ready</span>\n- open all 9 chests first`;
    return;
  }

  const userFlag = ($("flagIn").value || "").trim();
  if(!userFlag){
    log.innerHTML = `Status: <span class="err">missing flag</span>`;
    return;
  }

  const expected = await expectedFlagFromKeys();
  if(!expected){
    log.innerHTML = `Status: <span class="err">missing key-material</span>\n- something went wrong with keys`;
    return;
  }

  if(userFlag !== expected){
    log.innerHTML = `Status: <span class="err">incorrect</span>\n- check order / separators / uppercase hex / no spaces`;
    return;
  }

  // Success
  log.innerHTML = `Status: <span class="ok">correct</span>`;
  const url = b64Decode(CONFIG.sheetUrlB64);
  if(!url || url.startsWith("PUT_")){
    $("sheetLink").href = "#";
    $("sheetLink").textContent = "Sheet URL not configured";
  }else{
    $("sheetLink").href = url;
  }
  $("reward").style.display = "block";
}

/* ======================
   Builder mode (?build=1)
   ====================== */
function isBuildMode(){
  const u = new URL(location.href);
  return u.searchParams.get("build") === "1";
}

async function runBuilder(){
  $("builder").classList.add("show");
  $("btnBuild").addEventListener("click", async ()=>{
    const raw = ($("keysIn").value || "").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(raw.length !== 9){
      $("buildOut").textContent = `Need exactly 9 keys (one per line). Found: ${raw.length}`;
      return;
    }
    const hashes = [];
    for(const k of raw){
      hashes.push(await sha256Hex(k));
    }
    $("buildOut").textContent =
      "Paste into CONFIG.keyHashes (S1..S9 order):\n\n" +
      JSON.stringify(hashes, null, 2);
  });
}

(async function init(){
  mount();
  if(isBuildMode()){
    await runBuilder();
  }
})();
</script>
</body>
</html>
